(function(a,t,k){var s="beforeChangeOffset";var r="afterChangeOffset";var p="pullstart";var o="pulling";var m=s;var l=r;var n="dragEndAfterChangeOffset";var j=a.className("transitioning");var h=a.className("pull-top-tips");var c=a.className("pull-bottom-tips");var d=a.className("pull-loading");var i=a.className("scroll");var e=a.className("pull-loading")+" "+a.className("icon")+" "+a.className("icon-pulldown");var f=e+" "+a.className("reverse");var g=a.className("pull-loading")+" "+a.className("spinner");var b=a.className("hidden");var q="."+d;a.PullToRefresh=a.Class.extend({init:function(u,v){this.element=u;this.options=a.extend(true,{down:{height:75,callback:false,},up:{auto:false,offset:100,show:true,contentdown:"上拉显示更多",contentrefresh:"正在加载...",contentnomore:"没有更多数据了",callback:false},preventDefaultException:{tagName:/^(INPUT|TEXTAREA|BUTTON|SELECT)$/}},v);this.stopped=this.isNeedRefresh=this.isDragging=false;this.state=s;this.isInScroll=this.element.classList.contains(i);this.initPullUpTips();this.initEvent()},_preventDefaultException:function(u,v){for(var w in v){if(v[w].test(u[w])){return true}}return false},initEvent:function(){if(a.isFunction(this.options.down.callback)){this.element.addEventListener("touchstart",this);this.element.addEventListener("drag",this);this.element.addEventListener("dragend",this)}if(this.pullUpTips){this.element.addEventListener("dragup",this);t.addEventListener("scroll",this);if(this.isInScroll){this.element.addEventListener("scrollbottom",this)}}},handleEvent:function(u){switch(u.type){case"touchstart":this.isInScroll&&this._canPullDown()&&u.target&&!this._preventDefaultException(u.target,this.options.preventDefaultException)&&u.preventDefault();break;case"drag":this._drag(u);break;case"dragend":this._dragend(u);break;case"webkitTransitionEnd":this._transitionEnd(u);break;case"dragup":case"scroll":this._dragup(u);break;case"scrollbottom":this.pullUpLoading(u);break}},initPullDownTips:function(){var u=this;if(a.isFunction(u.options.down.callback)){u.pullDownTips=(function(){var v=k.querySelector("."+h);if(v){v.parentNode.removeChild(v)}if(!v){v=k.createElement("div");v.classList.add(h);v.innerHTML='<div class="mui-pull-top-wrapper"><span class="mui-pull-loading mui-icon mui-icon-pulldown"></span></div>';v.addEventListener("webkitTransitionEnd",u)}u.pullDownTipsIcon=v.querySelector(q);k.body.appendChild(v);return v}())}},initPullUpTips:function(){var u=this;if(a.isFunction(u.options.up.callback)){u.pullUpTips=(function(){var v=u.element.querySelector("."+c);if(!v){v=k.createElement("div");v.classList.add(c);if(!u.options.up.show){v.classList.add(b)}v.innerHTML='<div class="mui-pull-bottom-wrapper"><span class="mui-pull-loading">'+u.options.up.contentdown+"</span></div>";u.element.appendChild(v)}u.pullUpTipsIcon=v.querySelector(q);return v}())}},_transitionEnd:function(u){if(u.target===this.pullDownTips&&this.removing){this.removePullDownTips()}},_dragup:function(u){var v=this;if(v.loading){return}if(u&&u.detail&&a.gestures.session.drag){v.isDraggingUp=true}else{if(!v.isDraggingUp){return}}if(!v.isDragging){if(v._canPullUp()){v.pullUpLoading(u)}}},_canPullUp:function(){if(this.removing){return false}if(this.isInScroll){var v=this.element.parentNode.getAttribute("data-scroll");if(v){var u=a.data[v];return u.y===u.maxScrollY}}return t.pageYOffset+t.innerHeight+this.options.up.offset>=k.documentElement.scrollHeight},_canPullDown:function(){if(this.removing){return false}if(this.isInScroll){var v=this.element.parentNode.getAttribute("data-scroll");if(v){var u=a.data[v];return u.y===0}}return k.body.scrollTop===0},_drag:function(x){if(this.loading||this.stopped){x.stopPropagation();x.detail.gesture.preventDefault();return}var w=x.detail;if(!this.isDragging){if(w.direction==="down"&&this._canPullDown()){if(k.querySelector("."+h)){x.stopPropagation();x.detail.gesture.preventDefault();return}this.isDragging=true;this.removing=false;this.startDeltaY=w.deltaY;a.gestures.session.lockDirection=true;a.gestures.session.startDirection=w.direction;this._pullStart(this.startDeltaY)}}if(this.isDragging){x.stopPropagation();x.detail.gesture.preventDefault();var v=w.deltaY-this.startDeltaY;v=Math.min(v,1.5*this.options.down.height);this.deltaY=v;this._pulling(v);var y=v>this.options.down.height?r:s;if(this.state!==y){this.state=y;if(this.state===r){this.removing=false;this.isNeedRefresh=true}else{this.removing=true;this.isNeedRefresh=false}this["_"+y](v)}if(a.os.ios&&parseFloat(a.os.version)>=8){var u=w.gesture.touches[0].clientY;if((u+10)>t.innerHeight||u<10){this._dragend(x);return}}}},_dragend:function(u){var v=this;if(v.isDragging){v.isDragging=false;v._dragEndAfterChangeOffset(v.isNeedRefresh)}if(v.isPullingUp){if(v.pullingUpTimeout){clearTimeout(v.pullingUpTimeout)}v.pullingUpTimeout=setTimeout(function(){v.isPullingUp=false},1000)}},_pullStart:function(u){this.pullStart(u);a.trigger(this.element,p,{api:this,startDeltaY:u})},_pulling:function(u){this.pulling(u);a.trigger(this.element,o,{api:this,deltaY:u})},_beforeChangeOffset:function(u){this.beforeChangeOffset(u);a.trigger(this.element,m,{api:this,deltaY:u})},_afterChangeOffset:function(u){this.afterChangeOffset(u);a.trigger(this.element,l,{api:this,deltaY:u})},_dragEndAfterChangeOffset:function(u){this.dragEndAfterChangeOffset(u);a.trigger(this.element,n,{api:this,isNeedRefresh:u})},removePullDownTips:function(){if(this.pullDownTips){try{this.pullDownTips.parentNode&&this.pullDownTips.parentNode.removeChild(this.pullDownTips);this.pullDownTips=null;this.removing=false}catch(u){}}},pullStart:function(u){this.initPullDownTips(u)},pulling:function(u){this.pullDownTips.style.webkitTransform="translate3d(0,"+u+"px,0)"},beforeChangeOffset:function(u){this.pullDownTipsIcon.className=e},afterChangeOffset:function(u){this.pullDownTipsIcon.className=f},dragEndAfterChangeOffset:function(u){if(u){this.pullDownTipsIcon.className=g;this.pullDownLoading()}else{this.pullDownTipsIcon.className=e;this.endPullDownToRefresh()}},pullDownLoading:function(){if(this.loading){return}if(!this.pullDownTips){this.initPullDownTips();this.dragEndAfterChangeOffset(true);return}this.loading=true;this.pullDownTips.classList.add(j);this.pullDownTips.style.webkitTransform="translate3d(0,"+this.options.down.height+"px,0)";this.options.down.callback.apply(this)},pullUpLoading:function(u){if(this.loading||this.finished){return}this.loading=true;this.isDraggingUp=false;this.pullUpTips.classList.remove(b);u&&u.detail&&u.detail.gesture&&u.detail.gesture.preventDefault();this.pullUpTipsIcon.innerHTML=this.options.up.contentrefresh;this.options.up.callback.apply(this)},endPullDownToRefresh:function(){this.loading=false;this.pullUpTips&&this.pullUpTips.classList.remove(b);this.pullDownTips.classList.add(j);this.pullDownTips.style.webkitTransform="translate3d(0,0,0)";if(this.deltaY<=0){this.removePullDownTips()}else{this.removing=true}},endPullUpToRefresh:function(u){if(u){this.finished=true;this.pullUpTipsIcon.innerHTML=this.options.up.contentnomore;this.element.removeEventListener("dragup",this);t.removeEventListener("scroll",this)}else{this.pullUpTipsIcon.innerHTML=this.options.up.contentdown}this.loading=false},setStopped:function(u){if(u!=this.stopped){this.stopped=u;this.pullUpTips&&this.pullUpTips.classList[u?"add":"remove"](b)}},refresh:function(u){if(u&&this.finished&&this.pullUpTipsIcon){this.pullUpTipsIcon.innerHTML=this.options.up.contentdown;this.element.addEventListener("dragup",this);t.addEventListener("scroll",this);this.finished=false}}});a.fn.pullToRefresh=function(u){var v=[];u=u||{};this.each(function(){var y=this;var x=null;var w=y.getAttribute("data-pullToRefresh");if(!w){w=++a.uuid;a.data[w]=x=new a.PullToRefresh(y,u);y.setAttribute("data-pullToRefresh",w)}else{x=a.data[w]}if(u.up&&u.up.auto){x.pullUpLoading()}v.push(x)});return v.length===1?v[0]:v}})(mui,window,document);